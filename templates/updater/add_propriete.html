{% extends 'base.html' %}

{% block title %}Ajouter une Propriété{% endblock %}

{% block page_title %}
<i class="fas fa-plus"></i> Ajouter une Propriété
{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="cyber-card" style="max-width: 800px; margin: 0 auto;">
        <h3 style="font-family: 'Orbitron', monospace; margin-bottom: 2rem; color: var(--primary-neon);">
            <i class="fas fa-home"></i> Nouvelle Propriété
        </h3>
        
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- Photo principale -->
            <div class="form-group">
                <label class="form-label">Photo Principale</label>
                <div style="border: 2px dashed var(--border-glow); border-radius: 10px; padding: 2rem; text-align: center;" id="mainPhotoZone">
                    <i class="fas fa-camera" style="font-size: 3rem; color: var(--primary-neon); margin-bottom: 1rem;"></i>
                    <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                        Ajoutez la photo principale de la propriété
                    </p>
                    <input type="file" id="mainPhoto" name="main_photo" accept="image/*" style="display: none;">
                    <button type="button" class="cyber-btn" onclick="document.getElementById('mainPhoto').click()">
                        <i class="fas fa-upload"></i> Choisir une photo
                    </button>
                </div>
                <div id="mainPhotoPreview" style="margin-top: 1rem; display: none;">
                    <img id="previewImage" style="max-width: 200px; max-height: 150px; border-radius: 10px;">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">{{ form.titre.label }}</label>
                    {{ form.titre }}
                </div>
                <div class="form-group">
                    <label class="form-label">{{ form.prix.label }}</label>
                    {{ form.prix }}
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">{{ form.description.label }}</label>
                {{ form.description }}
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">{{ form.superficie.label }}</label>
                    {{ form.superficie }}
                </div>
                <div class="form-group">
                    <label class="form-label">{{ form.chambres.label }}</label>
                    {{ form.chambres }}
                </div>
                <div class="form-group">
                    <label class="form-label">{{ form.salles_bain.label }}</label>
                    {{ form.salles_bain }}
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">{{ form.adresse.label }}</label>
                {{ form.adresse }}
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">{{ form.ville.label }}</label>
                    {{ form.ville }}
                </div>
                <div class="form-group">
                    <label class="form-label">{{ form.quartier.label }}</label>
                    {{ form.quartier }}
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">{{ form.type_propriete.label }}</label>
                    {{ form.type_propriete }}
                </div>
                <div class="form-group">
                    <label class="form-label">{{ form.status.label }}</label>
                    {{ form.status }}
                </div>
            </div>
            
            <!-- Géolocalisation automatique -->
            <div class="cyber-card" style="margin: 2rem 0; background: rgba(0, 255, 136, 0.1);">
                <h4 style="color: var(--primary-neon); margin-bottom: 1rem;">
                    <i class="fas fa-map-marker-alt"></i> Géolocalisation
                </h4>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    La position GPS sera automatiquement capturée lors de l'ajout de la photo principale.
                </p>
                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="cyber-btn" onclick="getCurrentLocation()">
                        <i class="fas fa-crosshairs"></i> Utiliser ma position actuelle
                    </button>
                    <button type="button" class="cyber-btn" onclick="openLocationModal()">
                        <i class="fas fa-map"></i> Choisir sur la carte
                    </button>
                </div>
                <div id="locationInfo" style="margin-top: 1rem; display: none;">
                    <p style="color: var(--primary-neon);">
                        <i class="fas fa-check"></i> Position enregistrée
                    </p>
                </div>
            </div>
            
            {{ form.latitude }}
            {{ form.longitude }}
            
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="submit" class="cyber-btn" style="flex: 1;">
                    <i class="fas fa-save"></i> Enregistrer la propriété
                </button>
                <a href="{% url 'updater:proprietes' %}" class="cyber-btn" style="background: var(--text-secondary); flex: 1; text-align: center; text-decoration: none;">
                    <i class="fas fa-times"></i> Annuler
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Modal de géolocalisation -->
<div id="locationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 600px; height: 70%; background: var(--bg-card); border-radius: 15px; padding: 2rem;">
        <h3 style="margin-bottom: 1rem; color: var(--primary-neon);">Sélectionner la localisation</h3>
        <div id="map" style="height: 400px; border-radius: 10px; margin-bottom: 1rem;"></div>
        <div style="display: flex; gap: 1rem;">
            <button class="cyber-btn" onclick="confirmLocation()" style="flex: 1;">
                <i class="fas fa-check"></i> Confirmer
            </button>
            <button class="cyber-btn" onclick="closeLocationModal()" style="background: var(--text-secondary); flex: 1;">
                <i class="fas fa-times"></i> Annuler
            </button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script>
let map, marker;
let selectedLat, selectedLng;

// Prévisualisation de la photo principale
document.getElementById('mainPhoto').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImage').src = e.target.result;
            document.getElementById('mainPhotoPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
        
        // Essayer de récupérer les métadonnées EXIF pour la géolocalisation
        getImageLocation(file);
    }
});

// Géolocalisation actuelle
function getCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            selectedLat = position.coords.latitude;
            selectedLng = position.coords.longitude;
            updateLocationFields();
            document.getElementById('locationInfo').style.display = 'block';
        }, function(error) {
            alert('Erreur de géolocalisation: ' + error.message);
        });
    } else {
        alert('La géolocalisation n\'est pas supportée par ce navigateur.');
    }
}

// Modal de carte
function openLocationModal() {
    document.getElementById('locationModal').style.display = 'block';
    
    setTimeout(() => {
        map = L.map('map').setView([0.3476, 32.5825], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        map.on('click', function(e) {
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker(e.latlng).addTo(map);
            selectedLat = e.latlng.lat;
            selectedLng = e.latlng.lng;
        });
    }, 100);
}

function closeLocationModal() {
    document.getElementById('locationModal').style.display = 'none';
    if (map) {
        map.remove();
    }
}

function confirmLocation() {
    if (selectedLat && selectedLng) {
        updateLocationFields();
        document.getElementById('locationInfo').style.display = 'block';
    }
    closeLocationModal();
}

function updateLocationFields() {
    document.getElementById('id_latitude').value = selectedLat;
    document.getElementById('id_longitude').value = selectedLng;
}

// Extraction de géolocalisation depuis les métadonnées EXIF (basique)
function getImageLocation(file) {
    // Cette fonction pourrait être étendue avec une bibliothèque EXIF
    // Pour l'instant, on utilise la géolocalisation actuelle comme fallback
    getCurrentLocation();
}
</script>
{% endblock %}